                      
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رحلة HTTP Request في .NET Core API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .flow-container {
            position: relative;
            padding: 20px 0;
        }
        
        .section {
            margin-bottom: 60px;
            position: relative;
        }
        
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 30px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-right: 40px;
        }
        
        .step {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            border-right: 5px solid #667eea;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .step:hover {
            transform: translateX(-10px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .step-number {
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }
        
        .step-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-icon {
            font-size: 1.5em;
        }
        
        .step-desc {
            color: #555;
            line-height: 1.6;
            margin-right: 35px;
        }
        
        .best-practices {
            background: linear-gradient(135deg, #d4f1d4 0%, #a8e6cf 100%);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-right: 4px solid #28a745;
        }
        
        .bp-title {
            font-weight: bold;
            color: #155724;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        
        .best-practices ul {
            margin: 10px 0;
            padding-right: 20px;
        }
        
        .security-note {
            background: linear-gradient(135deg, #ffe6e6 0%, #ffcccc 100%);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-right: 4px solid #dc3545;
        }
        
        .security-title {
            font-weight: bold;
            color: #721c24;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        
        .performance-note {
            background: linear-gradient(135deg, #e6f3ff 0%, #cce5ff 100%);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-right: 4px solid #007bff;
        }
        
        .performance-title {
            font-weight: bold;
            color: #004085;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        
        .code-block {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            font-size: 0.9em;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }
        
        .arrow {
            text-align: center;
            font-size: 2em;
            color: #667eea;
            margin: 10px 0;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(10px); }
        }
        
        .middleware-pipeline {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: 15px;
            border: 3px dashed #667eea;
        }
        
        .middleware-item {
            background: white;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 10px;
            border-right: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .middleware-item:hover {
            transform: translateX(-5px);
            border-right-width: 8px;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border-right: 4px solid #ffc107;
            margin: 20px 0;
        }
        
        .highlight-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .timeline {
            position: relative;
            padding-right: 50px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }
        
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }
        
        .flow-box {
            background: white;
            border: 3px solid #667eea;
            padding: 20px;
            border-radius: 15px;
            min-width: 150px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .flow-arrow {
            font-size: 2em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 رحلة HTTP Request في .NET Core API</h1>
        <p class="subtitle">من المتصفح إلى قاعدة البيانات والعودة</p>
        
        <div class="flow-container">
            <!-- Section 1: Browser -->
            <div class="section">
                <div class="section-title">🌐 المرحلة الأولى: المتصفح والشبكة</div>
                <div class="timeline">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-title">
                            <span class="step-icon">🔍</span>
                            <span>كتابة URL</span>
                        </div>
                        <div class="step-desc">
                            المستخدم يكتب: <strong>https://myapi.com/api/products/5</strong>
                        </div>
                        <div class="code-block">GET /api/products/5 HTTP/1.1<br>Host: myapi.com</div>
                        <div class="best-practices">
                            <div class="bp-title">⚡ Best Practices:</div>
                            • استخدم <strong>HTTPS</strong> دائماً وليس HTTP<br>
                            • استخدم <strong>HTTP/2</strong> لتحسين الأداء<br>
                            • طبق <strong>URL Versioning</strong>: /api/v1/products<br>
                            • استخدم <strong>RESTful naming</strong>: أسماء جمع للـ resources
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-title">
                            <span class="step-icon">📡</span>
                            <span>DNS Resolution</span>
                        </div>
                        <div class="step-desc">
                            تحويل اسم الدومين إلى IP Address<br>
                            <strong>myapi.com → 192.168.1.100</strong>
                        </div>
                        <div class="performance-note">
                            <div class="performance-title">🚀 Performance Tips:</div>
                            • استخدم <strong>DNS Caching</strong> لتقليل الوقت<br>
                            • طبق <strong>DNS Prefetching</strong> للموارد الخارجية<br>
                            • استخدم <strong>CDN</strong> مع DNS السريع (Cloudflare, AWS Route 53)<br>
                            • راقب <strong>DNS lookup time</strong> باستمرار
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-title">
                            <span class="step-icon">🔌</span>
                            <span>TCP Connection + SSL/TLS</span>
                        </div>
                        <div class="step-desc">
                            عمل اتصال آمن مع السيرفر عن طريق:<br>
                            • TCP 3-Way Handshake<br>
                            • SSL/TLS Handshake للتشفير
                        </div>
                        <div class="security-note">
                            <div class="security-title">🔒 Security Requirements:</div>
                            • استخدم <strong>TLS 1.2 أو 1.3</strong> فقط (إيقاف 1.0 و 1.1)<br>
                            • طبق <strong>Certificate Pinning</strong> للـ mobile apps<br>
                            • استخدم <strong>HSTS</strong> (HTTP Strict Transport Security)<br>
                            • فعّل <strong>Perfect Forward Secrecy</strong>
                        </div>
                        <div class="performance-note">
                            <div class="performance-title">🚀 Performance:</div>
                            • استخدم <strong>Connection Pooling</strong><br>
                            • فعّل <strong>Keep-Alive</strong> لإعادة استخدام الاتصالات<br>
                            • استخدم <strong>HTTP/2 or HTTP/3</strong> للـ multiplexing
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-title">
                            <span class="step-icon">📤</span>
                            <span>إرسال HTTP Request</span>
                        </div>
                        <div class="step-desc">
                            المتصفح يرسل الطلب للسيرفر بكل التفاصيل (Headers, Method, URL)
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="arrow">⬇⬇⬇</div>
            
            <!-- Section 2: Web Server -->
            <div class="section">
                <div class="section-title">🖥️ المرحلة الثانية: الـ Web Server (Kestrel/IIS)</div>
                <div class="timeline">
                    <div class="step">
                        <div class="step-number">5</div>
                        <div class="step-title">
                            <span class="step-icon">⚡</span>
                            <span>Kestrel يستقبل الطلب</span>
                        </div>
                        <div class="step-desc">
                            السيرفر الافتراضي في .NET Core يستقبل الـ HTTP Request ويبدأ معالجته
                        </div>
                        <div class="best-practices">
                            <div class="bp-title">⚡ Kestrel Configuration:</div>
                            • اضبط <strong>Request Limits</strong> (Max Body Size, Timeout)<br>
                            • استخدم <strong>IIS/Nginx</strong> كـ Reverse Proxy للإنتاج<br>
                            • فعّل <strong>Response Compression</strong> (Gzip/Brotli)<br>
                            • اضبط <strong>Thread Pool Settings</strong> حسب الحمل
                        </div>
                        <div class="code-block">
builder.WebHost.ConfigureKestrel(options => {<br>
    options.Limits.MaxRequestBodySize = 10 * 1024 * 1024; // 10MB<br>
    options.Limits.RequestHeadersTimeout = TimeSpan.FromSeconds(30);<br>
});
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="arrow">⬇⬇⬇</div>
            
            <!-- Section 3: Middleware Pipeline -->
            <div class="section">
                <div class="section-title">🔄 المرحلة الثالثة: Middleware Pipeline</div>
                <div class="highlight">
                    <div class="highlight-title">⚠️ ملحوظة مهمة:</div>
                    الـ Request بيمر في كل middleware بالترتيب، والـ Response بيرجع فيهم بالعكس!
                </div>
                
                <div class="middleware-pipeline">
                    <div class="middleware-item">
                        <strong>🛡️ Exception Handler Middleware</strong><br>
                        <small>معالجة الأخطاء والـ Exceptions</small>
                        <div class="best-practices" style="margin-top: 10px;">
                            <div class="bp-title">⚡ Important:</div>
                            • استخدم <strong>Global Exception Handler</strong><br>
                            • سجل الـ Exceptions في <strong>Logging Service</strong> (Serilog, NLog)<br>
                            • أرجع <strong>Consistent Error Response</strong> للـ client<br>
                            • لا تكشف <strong>Stack Trace</strong> في الإنتاج<br>
                            • استخدم <strong>Problem Details (RFC 7807)</strong>
                        </div>
                        <div class="code-block" style="margin-top: 10px;">
app.UseExceptionHandler("/error");<br>
app.UseStatusCodePages();<br>
// في الإنتاج: لا تستخدم UseDeveloperExceptionPage()
                        </div>
                    </div>
                    <div class="arrow">⬇</div>
                    
                    <div class="middleware-item">
                        <strong>🔒 HTTPS Redirection</strong><br>
                        <small>تحويل HTTP لـ HTTPS</small>
                    </div>
                    <div class="arrow">⬇</div>
                    
                    <div class="middleware-item">
                        <strong>📁 Static Files Middleware</strong><br>
                        <small>التحقق من الملفات الثابتة (CSS, JS, Images)</small>
                    </div>
                    <div class="arrow">⬇</div>
                    
                    <div class="middleware-item">
                        <strong>🗺️ Routing Middleware</strong><br>
                        <small>مطابقة الـ URL مع الـ Routes المعرفة</small>
                        <div class="code-block">/api/products/5 → ProductsController.GetProduct(5)</div>
                        <div class="best-practices" style="margin-top: 10px;">
                            <div class="bp-title">⚡ Routing Best Practices:</div>
                            • استخدم <strong>Attribute Routing</strong> بدلاً من Convention-based<br>
                            • طبق <strong>API Versioning</strong> (Microsoft.AspNetCore.Mvc.Versioning)<br>
                            • استخدم <strong>Route Constraints</strong> للـ validation<br>
                            • وثّق الـ APIs باستخدام <strong>Swagger/OpenAPI</strong>
                        </div>
                        <div class="code-block" style="margin-top: 10px;">
[ApiVersion("1.0")]<br>
[Route("api/v{version:apiVersion}/[controller]")]<br>
[HttpGet("{id:int:min(1)}")]
                        </div>
                    </div>
                    <div class="arrow">⬇</div>
                    
                    <div class="middleware-item">
                        <strong>🔐 Authentication</strong><br>
                        <small>التحقق من هوية المستخدم (JWT Token)</small>
                        <div class="security-note" style="margin-top: 10px;">
                            <div class="security-title">🔒 Critical Security:</div>
                            • استخدم <strong>JWT</strong> مع <strong>Refresh Tokens</strong><br>
                            • خزن الـ tokens في <strong>HttpOnly Cookies</strong> أو Secure Storage<br>
                            • طبق <strong>Token Expiration</strong> قصيرة (15-30 دقيقة)<br>
                            • استخدم <strong>Strong Secret Keys</strong> (256-bit minimum)<br>
                            • فعّل <strong>Token Revocation</strong> للـ logout<br>
                            • طبق <strong>Multi-Factor Authentication</strong> للحسابات الحساسة
                        </div>
                        <div class="code-block" style="margin-top: 10px;">
services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)<br>
    .AddJwtBearer(options => {<br>
        options.TokenValidationParameters = new() {<br>
            ValidateIssuerSigningKey = true,<br>
            ValidateLifetime = true,<br>
            ClockSkew = TimeSpan.Zero<br>
        };<br>
    });
                        </div>
                    </div>
                    <div class="arrow">⬇</div>
                    
                    <div class="middleware-item">
                        <strong>✅ Authorization</strong><br>
                        <small>التحقق من الصلاحيات والـ Permissions</small>
                        <div class="best-practices" style="margin-top: 10px;">
                            <div class="bp-title">⚡ Authorization Patterns:</div>
                            • استخدم <strong>Policy-Based Authorization</strong><br>
                            • طبق <strong>Role-Based</strong> و <strong>Claims-Based</strong> Authorization<br>
                            • استخدم <strong>Resource-Based Authorization</strong> للبيانات الحساسة<br>
                            • طبق <strong>Principle of Least Privilege</strong><br>
                            • فعّل <strong>Authorization Logging</strong>
                        </div>
                        <div class="code-block" style="margin-top: 10px;">
services.AddAuthorization(options => {<br>
    options.AddPolicy("AdminOnly", policy => <br>
        policy.RequireRole("Admin"));<br>
    options.AddPolicy("CanEditProduct", policy => <br>
        policy.RequireClaim("Permission", "Product.Edit"));<br>
});
                        </div>
                    </div>
                    <div class="arrow">⬇</div>
                    
                    <div class="middleware-item">
                        <strong>🌍 CORS Middleware</strong><br>
                        <small>السماح بالطلبات من دومينات مختلفة</small>
                        <div class="security-note" style="margin-top: 10px;">
                            <div class="security-title">🔒 CORS Security:</div>
                            • <strong>لا تستخدم AllowAnyOrigin()</strong> في الإنتاج<br>
                            • حدد الـ <strong>Origins المسموحة</strong> بدقة<br>
                            • استخدم <strong>WithOrigins()</strong> مع قائمة محددة<br>
                            • فعّل <strong>Credentials</strong> فقط عند الحاجة<br>
                            • قيّد الـ <strong>HTTP Methods والـ Headers</strong>
                        </div>
                        <div class="code-block" style="margin-top: 10px;">
builder.Services.AddCors(options => {<br>
    options.AddPolicy("Production", policy => {<br>
        policy.WithOrigins("https://myapp.com")<br>
              .WithMethods("GET", "POST")<br>
              .AllowCredentials();<br>
    });<br>
});
                        </div>
                    </div>
                    <div class="arrow">⬇</div>
                    
                    <div class="middleware-item">
                        <strong>🎯 Endpoint Middleware</strong><br>
                        <small>تنفيذ الـ Controller والـ Action</small>
                    </div>
                </div>
            </div>
            
            <div class="arrow">⬇⬇⬇</div>
            
            <!-- Section 4: Controller -->
            <div class="section">
                <div class="section-title">🎮 المرحلة الرابعة: Controller & Action</div>
                <div class="timeline">
                    <div class="step">
                        <div class="step-number">6</div>
                        <div class="step-title">
                            <span class="step-icon">🔧</span>
                            <span>Model Binding & Validation</span>
                        </div>
                        <div class="step-desc">
                            تحويل الـ request data إلى C# objects<br>
                            • Route Parameters: id = 5<br>
                            • Query Strings<br>
                            • Request Body
                        </div>
                        <div class="security-note">
                            <div class="security-title">🔒 Input Validation:</div>
                            • استخدم <strong>Data Annotations</strong> دائماً<br>
                            • طبق <strong>FluentValidation</strong> للـ Complex Rules<br>
                            • فعّل <strong>Anti-Forgery Tokens</strong> للـ POST/PUT/DELETE<br>
                            • قيّد <strong>Max Length</strong> للـ strings<br>
                            • استخدم <strong>[ApiController]</strong> للـ Auto Validation<br>
                            • احذر من <strong>Mass Assignment</strong> - استخدم DTOs
                        </div>
                        <div class="code-block">
public class CreateProductDto {<br>
    [Required, MaxLength(100)]<br>
    public string Name { get; set; }<br>
    <br>
    [Range(0.01, 999999)]<br>
    public decimal Price { get; set; }<br>
}
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">7</div>
                        <div class="step-title">
                            <span class="step-icon">💉</span>
                            <span>Dependency Injection</span>
                        </div>
                        <div class="step-desc">
                            حقن الـ Dependencies المطلوبة في الـ Controller
                        </div>
                        <div class="code-block">
public ProductsController(IProductService service)<br>
{<br>
    _service = service; // حقن من DI Container<br>
}
                        </div>
                        <div class="best-practices">
                            <div class="bp-title">⚡ DI Best Practices:</div>
                            • استخدم <strong>Constructor Injection</strong> دائماً<br>
                            • سجل الـ Services بـ <strong>Scoped/Transient/Singleton</strong> صح:<br>
                            &nbsp;&nbsp;- DbContext: <strong>Scoped</strong><br>
                            &nbsp;&nbsp;- Business Services: <strong>Scoped</strong><br>
                            &nbsp;&nbsp;- Caching/Configuration: <strong>Singleton</strong><br>
                            • استخدم <strong>Interfaces</strong> للـ loose coupling<br>
                            • احذر من <strong>Captive Dependencies</strong><br>
                            • طبق <strong>Service Lifetimes</strong> صح
                        </div>
                        <div class="code-block">
builder.Services.AddScoped&lt;IProductService, ProductService&gt;();<br>
builder.Services.AddDbContext&lt;AppDbContext&gt;(ServiceLifetime.Scoped);
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">8</div>
                        <div class="step-title">
                            <span class="step-icon">🎬</span>
                            <span>Action Filters</span>
                        </div>
                        <div class="step-desc">
                            تنفيذ الـ Filters قبل وبعد الـ Action Method<br>
                            • Authorization Filters<br>
                            • Action Filters<br>
                            • Result Filters
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">9</div>
                        <div class="step-title">
                            <span class="step-icon">⚙️</span>
                            <span>Action Method Execution</span>
                        </div>
                        <div class="step-desc">
                            تنفيذ الكود داخل الـ Controller Action
                        </div>
                        <div class="code-block">
[HttpGet("{id}")]<br>
public async Task&lt;IActionResult&gt; GetProduct(int id)<br>
{<br>
    var product = await _service.GetProductAsync(id);<br>
    return Ok(product);<br>
}
                        </div>
                        <div class="best-practices">
                            <div class="bp-title">⚡ Controller Best Practices:</div>
                            • استخدم <strong>async/await</strong> دائماً للـ I/O operations<br>
                            • أرجع <strong>Proper HTTP Status Codes</strong> (200, 201, 404, 400, 500)<br>
                            • استخدم <strong>ActionResult&lt;T&gt;</strong> للـ type safety<br>
                            • طبق <strong>Pagination</strong> للـ large datasets<br>
                            • استخدم <strong>DTOs</strong> للـ input/output (AutoMapper)<br>
                            • لا تضع <strong>Business Logic</strong> في الـ Controller
                        </div>
                        <div class="code-block">
[HttpGet]<br>
public async Task&lt;ActionResult&lt;PagedResult&lt;ProductDto&gt;&gt;&gt; GetAll(<br>
    [FromQuery] int page = 1, [FromQuery] int pageSize = 20)<br>
{<br>
    if(pageSize > 100) return BadRequest("Max page size is 100");<br>
    var result = await _service.GetPagedAsync(page, pageSize);<br>
    return Ok(result);<br>
}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="arrow">⬇⬇⬇</div>
            
            <!-- Section 5: Business Logic -->
            <div class="section">
                <div class="section-title">💼 المرحلة الخامسة: Business Logic Layer</div>
                <div class="timeline">
                    <div class="step">
                        <div class="step-number">10</div>
                        <div class="step-title">
                            <span class="step-icon">🏢</span>
                            <span>Service Layer (Business Logic)</span>
                        </div>
                        <div class="step-desc">
                            تنفيذ منطق الأعمال (Business Rules)
                        </div>
                        <div class="code-block">
public async Task&lt;Product&gt; GetProductAsync(int id)<br>
{<br>
    return await _context.Products<br>
        .FirstOrDefaultAsync(p => p.Id == id);<br>
}
                        </div>
                        <div class="best-practices">
                            <div class="bp-title">⚡ Service Layer Best Practices:</div>
                            • ضع كل الـ <strong>Business Logic</strong> هنا<br>
                            • طبق <strong>Repository Pattern</strong> للـ data access<br>
                            • استخدم <strong>Unit of Work</strong> للـ transactions<br>
                            • طبق <strong>CQRS</strong> للتطبيقات المعقدة (MediatR)<br>
                            • استخدم <strong>Domain Events</strong> للـ decoupling<br>
                            • سجل كل الـ <strong>Business Operations</strong>
                        </div>
                        <div class="code-block">
public class ProductService : IProductService {<br>
    private readonly IUnitOfWork _unitOfWork;<br>
    private readonly ILogger _logger;<br>
    <br>
    public async Task&lt;Result&lt;Product&gt;&gt; GetProductAsync(int id) {<br>
        _logger.LogInformation("Fetching product {Id}", id);<br>
        var product = await _unitOfWork.Products.GetByIdAsync(id);<br>
        return product != null ? Result.Success(product) : Result.NotFound();<br>
    }<br>
}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="arrow">⬇⬇⬇</div>
            
            <!-- Section 6: Database -->
            <div class="section">
                <div class="section-title">🗄️ المرحلة السادسة: قاعدة البيانات</div>
                <div class="timeline">
                    <div class="step">
                        <div class="step-number">11</div>
                        <div class="step-title">
                            <span class="step-icon">🔄</span>
                            <span>Entity Framework Core</span>
                        </div>
                        <div class="step-desc">
                            ترجمة الـ LINQ Query إلى SQL Statement
                        </div>
                        <div class="code-block">
SELECT * FROM Products<br>
WHERE Id = 5
                        </div>
                        <div class="performance-note">
                            <div class="performance-title">🚀 EF Core Performance:</div>
                            • استخدم <strong>AsNoTracking()</strong> للـ read-only queries<br>
                            • طبق <strong>Projection</strong> - اختر الحقول المطلوبة فقط<br>
                            • احذر من <strong>N+1 Query Problem</strong> - استخدم Include/ThenInclude<br>
                            • استخدم <strong>Compiled Queries</strong> للـ frequently used queries<br>
                            • فعّل <strong>Query Splitting</strong> للـ complex joins<br>
                            • استخدم <strong>Bulk Operations</strong> للعمليات الكبيرة<br>
                            • فعّل <strong>Query Logging</strong> في Development
                        </div>
                        <div class="code-block">
// ❌ Bad - N+1 Problem<br>
var products = await _context.Products.ToListAsync();<br>
foreach(var p in products) {<br>
    var category = await _context.Categories.FindAsync(p.CategoryId);<br>
}<br>
<br>
// ✅ Good - Single Query<br>
var products = await _context.Products<br>
    .Include(p => p.Category)<br>
    .AsNoTracking()<br>
    .Select(p => new ProductDto {<br>
        Id = p.Id,<br>
        Name = p.Name,<br>
        CategoryName = p.Category.Name<br>
    })<br>
    .ToListAsync();
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">12</div>
                        <div class="step-title">
                            <span class="step-icon">💾</span>
                            <span>SQL Server Execution</span>
                        </div>
                        <div class="step-desc">
                            تنفيذ الاستعلام وإرجاع البيانات<br>
                            • Query Optimization<br>
                            • Index Seeking<br>
                            • Data Retrieval
                        </div>
                        <div class="performance-note">
                            <div class="performance-title">🚀 Database Performance:</div>
                            • أنشئ <strong>Indexes</strong> على الحقول المستخدمة في WHERE/JOIN<br>
                            • استخدم <strong>Composite Indexes</strong> للـ complex queries<br>
                            • راقب <strong>Execution Plans</strong> باستمرار<br>
                            • طبق <strong>Database Partitioning</strong> للجداول الكبيرة<br>
                            • استخدم <strong>Read Replicas</strong> لتوزيع الحمل<br>
                            • فعّل <strong>Query Store</strong> للتحليل<br>
                            • احذر من <strong>Table Scans</strong> - استخدم indexes
                        </div>
                        <div class="best-practices">
                            <div class="bp-title">⚡ Database Best Practices:</div>
                            • استخدم <strong>Connection Pooling</strong> (افتراضي في .NET)<br>
                            • اضبط <strong>CommandTimeout</strong> مناسب<br>
                            • طبق <strong>Database Migrations</strong> (EF Core Migrations)<br>
                            • استخدم <strong>Stored Procedures</strong> للعمليات المعقدة<br>
                            • فعّل <strong>Database Monitoring</strong> (Application Insights)<br>
                            • خطط لـ <strong>Backup Strategy</strong> و <strong>Disaster Recovery</strong>
                        </div>
                        <div class="code-block">
-- Create Index<br>
CREATE NONCLUSTERED INDEX IX_Products_CategoryId<br>
ON Products(CategoryId)<br>
INCLUDE (Name, Price);<br>
<br>
-- Connection String<br>
"Server=.;Database=MyDb;Pooling=true;Min Pool Size=5;Max Pool Size=100;"
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">13</div>
                        <div class="step-title">
                            <span class="step-icon">📦</span>
                            <span>Materialization</span>
                        </div>
                        <div class="step-desc">
                            تحويل البيانات من Database Rows إلى C# Objects
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="arrow">⬆⬆⬆ العودة للمستخدم ⬆⬆⬆</div>
            
            <!-- Section 7: Response -->
            <div class="section">
                <div class="section-title">📤 المرحلة السابعة: Response Pipeline</div>
                <div class="timeline">
                    <div class="step">
                        <div class="step-number">14</div>
                        <div class="step-title">
                            <span class="step-icon">✨</span>
                            <span>Action Result Processing</span>
                        </div>
                        <div class="step-desc">
                            معالجة نتيجة الـ Action (Ok, NotFound, BadRequest, etc.)
                        </div>
                        <div class="code-block">return Ok(product); // HTTP 200</div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">15</div>
                        <div class="step-title">
                            <span class="step-icon">🔄</span>
                            <span>JSON Serialization</span>
                        </div>
                        <div class="step-desc">
                            تحويل الـ C# Object إلى JSON باستخدام System.Text.Json
                        </div>
                        <div class="code-block">
{<br>
  "id": 5,<br>
  "name": "Product Name",<br>
  "price": 99.99<br>
}
                        </div>
                        <div class="best-practices">
                            <div class="bp-title">⚡ Serialization Best Practices:</div>
                            • استخدم <strong>System.Text.Json</strong> (أسرع من Newtonsoft)<br>
                            • طبق <strong>JsonSerializerOptions</strong> globally<br>
                            • استخدم <strong>[JsonIgnore]</strong> للحقول الحساسة<br>
                            • فعّل <strong>Camel Case</strong> naming policy<br>
                            • احذر من <strong>Circular References</strong><br>
                            • استخدم <strong>JsonPropertyName</strong> للتحكم في الأسماء
                        </div>
                        <div class="code-block">
builder.Services.ConfigureHttpJsonOptions(options => {<br>
    options.SerializerOptions.PropertyNamingPolicy = JsonNamingPolicy.CamelCase;<br>
    options.SerializerOptions.DefaultIgnoreCondition = <br>
        JsonIgnoreCondition.WhenWritingNull;<br>
    options.SerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;<br>
});
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">16</div>
                        <div class="step-title">
                            <span class="step-icon">🔙</span>
                            <span>Middleware Pipeline (Reverse)</span>
                        </div>
                        <div class="step-desc">
                            المرور في نفس الـ Middleware ولكن بالعكس<br>
                            كل middleware ممكن يعدل في الـ Response
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">17</div>
                        <div class="step-title">
                            <span class="step-icon">📡</span>
                            <span>HTTP Response</span>
                        </div>
                        <div class="step-desc">
                            إرسال الـ Response للمتصفح
                        </div>
                        <div class="code-block">
HTTP/1.1 200 OK<br>
Content-Type: application/json<br>
Content-Length: 65<br><br>
{"id":5,"name":"Product Name","price":99.99}
                        </div>
                        <div class="performance-note">
                            <div class="performance-title">🚀 Response Optimization:</div>
                            • فعّل <strong>Response Compression</strong> (Gzip/Brotli)<br>
                            • استخدم <strong>Response Caching</strong> للبيانات الثابتة<br>
                            • طبق <strong>ETag</strong> و <strong>Last-Modified</strong> headers<br>
                            • استخدم <strong>CDN</strong> للـ static content<br>
                            • فعّل <strong>HTTP/2 Server Push</strong> إن أمكن<br>
                            • اضبط <strong>Cache-Control</strong> headers صح
                        </div>
                        <div class="security-note">
                            <div class="security-title">🔒 Response Security:</div>
                            • اضف <strong>Security Headers</strong>:<br>
                            &nbsp;&nbsp;- X-Content-Type-Options: nosniff<br>
                            &nbsp;&nbsp;- X-Frame-Options: DENY<br>
                            &nbsp;&nbsp;- Content-Security-Policy<br>
                            &nbsp;&nbsp;- Strict-Transport-Security (HSTS)<br>
                            • لا ترجع <strong>Sensitive Data</strong> في الـ response<br>
                            • استخدم <strong>Rate Limiting</strong> لمنع الـ abuse
                        </div>
                        <div class="code-block">
app.Use(async (context, next) => {<br>
    context.Response.Headers.Add("X-Content-Type-Options", "nosniff");<br>
    context.Response.Headers.Add("X-Frame-Options", "DENY");<br>
    context.Response.Headers.Add("X-XSS-Protection", "1; mode=block");<br>
    await next();<br>
});
                        </div>
                    </div>
                    
                    <div class="arrow">⬇</div>
                    
                    <div class="step">
                        <div class="step-number">18</div>
                        <div class="step-title">
                            <span class="step-icon">🎨</span>
                            <span>Browser Rendering</span>
                        </div>
                        <div class="step-desc">
                            المتصفح يعرض البيانات للمستخدم<br>
                            • JavaScript يعالج الـ JSON<br>
                            • الصفحة تتحدث بالمحتوى الجديد<br>
                            • المستخدم يشوف المنتج! 🎉
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Summary -->
            <div class="highlight" style="margin-top: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <div class="highlight-title" style="color: white; font-size: 1.5em;">⏱️ الوقت المستغرق</div>
                <div style="font-size: 1.1em; line-height: 2;">
                    • DNS Resolution: 20-120ms<br>
                    • TCP + SSL Handshake: 40-200ms<br>
                    • Server Processing: 10-100ms<br>
                    • Database Query: 5-50ms<br>
                    • Response Transfer: 10-50ms<br>
                    <strong>إجمالي: 85-520ms في المتوسط</strong>
                </div>
            </div>
            
            <!-- Additional Best Practices Section -->
            <div class="section" style="margin-top: 50px;">
                <div class="section-title">🎯 مواضيع حرجة إضافية للتطبيقات الحقيقية</div>
                
                <div class="highlight" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; margin: 20px 0;">
                    <div class="highlight-title" style="color: white; font-size: 1.3em;">🔥 Caching Strategy</div>
                    <div style="line-height: 1.8;">
                        • <strong>Memory Cache</strong>: للبيانات قصيرة المدى (IMemoryCache)<br>
                        • <strong>Distributed Cache</strong>: Redis للتطبيقات الموزعة<br>
                        • <strong>Response Caching</strong>: للـ GET requests المتكررة<br>
                        • <strong>Output Caching</strong>: للـ full page caching<br>
                        • طبق <strong>Cache Invalidation Strategy</strong> واضح<br>
                        • استخدم <strong>Cache-Aside Pattern</strong>
                    </div>
                    <div class="code-block" style="margin-top: 10px;">
builder.Services.AddMemoryCache();<br>
builder.Services.AddStackExchangeRedisCache(options => {<br>
    options.Configuration = "localhost:6379";<br>
});<br>
<br>
// في الـ Service<br>
var product = await _cache.GetOrCreateAsync($"product_{id}", async entry => {<br>
    entry.SlidingExpiration = TimeSpan.FromMinutes(5);<br>
    return await _context.Products.FindAsync(id);<br>
});
                    </div>
                </div>
                
                <div class="highlight" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; margin: 20px 0;">
                    <div class="highlight-title" style="color: white; font-size: 1.3em;">📊 Logging & Monitoring</div>
                    <div style="line-height: 1.8;">
                        • استخدم <strong>Structured Logging</strong> (Serilog, NLog)<br>
                        • طبق <strong>Application Insights</strong> أو <strong>ELK Stack</strong><br>
                        • سجل كل <strong>Exceptions, Performance Metrics, Business Events</strong><br>
                        • استخدم <strong>Correlation IDs</strong> لتتبع الـ requests<br>
                        • فعّل <strong>Health Checks</strong> للـ endpoints<br>
                        • راقب <strong>Response Times, Memory, CPU</strong>
                    </div>
                    <div class="code-block" style="margin-top: 10px;">
builder.Services.AddHealthChecks()<br>
    .AddDbContextCheck&lt;AppDbContext&gt;()<br>
    .AddRedis("localhost:6379");<br>
<br>
Log.Logger = new LoggerConfiguration()<br>
    .WriteTo.Console()<br>
    .WriteTo.ApplicationInsights(telemetryConfig, TelemetryConverter.Traces)<br>
    .CreateLogger();
                    </div>
                </div>
                
                <div class="highlight" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; margin: 20px 0;">
                    <div class="highlight-title" style="color: white; font-size: 1.3em;">⚡ Rate Limiting & Throttling</div>
                    <div style="line-height: 1.8;">
                        • طبق <strong>Rate Limiting</strong> لمنع الـ abuse<br>
                        • استخدم <strong>AspNetCoreRateLimit</strong> package<br>
                        • حدد <strong>Limits per User/IP/Endpoint</strong><br>
                        • طبق <strong>Retry-After</strong> header للـ 429 responses<br>
                        • استخدم <strong>Token Bucket</strong> أو <strong>Sliding Window</strong> algorithm
                    </div>
                    <div class="code-block" style="margin-top: 10px;">
builder.Services.AddRateLimiter(options => {<br>
    options.GlobalLimiter = PartitionedRateLimiter.Create&lt;HttpContext, string&gt;(<br>
        context => RateLimitPartition.GetFixedWindowLimiter(<br>
            partitionKey: context.User.Identity?.Name ?? context.Request.Headers.Host.ToString(),<br>
            factory: partition => new FixedWindowRateLimiterOptions {<br>
                PermitLimit = 100,<br>
                Window = TimeSpan.FromMinutes(1)<br>
            }));<br>
});
                    </div>
                </div>
                
                <div class="highlight" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: #333; border: none; margin: 20px 0;">
                    <div class="highlight-title" style="color: #155724; font-size: 1.3em;">🔄 Background Jobs & Queues</div>
                    <div style="line-height: 1.8; color: #333;">
                        • استخدم <strong>Hangfire</strong> أو <strong>Quartz.NET</strong> للـ scheduled jobs<br>
                        • طبق <strong>Message Queues</strong> (RabbitMQ, Azure Service Bus)<br>
                        • استخدم <strong>IHostedService</strong> للـ background tasks<br>
                        • طبق <strong>Retry Policies</strong> مع <strong>Polly</strong><br>
                        • افصل الـ <strong>Long-running Operations</strong> عن الـ HTTP request
                    </div>
                    <div class="code-block" style="margin-top: 10px;">
builder.Services.AddHangfire(config => <br>
    config.UseSqlServerStorage(connectionString));<br>
<br>
// Schedule recurring job<br>
RecurringJob.AddOrUpdate("cleanup-job", <br>
    () => cleanupService.CleanupOldData(), <br>
    Cron.Daily);
                    </div>
                </div>
                
                <div class="highlight" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; border: none; margin: 20px 0;">
                    <div class="highlight-title" style="color: #721c24; font-size: 1.3em;">🧪 Testing Strategy</div>
                    <div style="line-height: 1.8; color: #333;">
                        • اكتب <strong>Unit Tests</strong> لكل الـ business logic (xUnit, NUnit)<br>
                        • طبق <strong>Integration Tests</strong> للـ API endpoints<br>
                        • استخدم <strong>WebApplicationFactory</strong> للـ testing<br>
                        • اكتب <strong>Load Tests</strong> (JMeter, k6)<br>
                        • طبق <strong>Mocking</strong> بـ Moq أو NSubstitute<br>
                        • استهدف <strong>80%+ Code Coverage</strong>
                    </div>
                    <div class="code-block" style="margin-top: 10px;">
public class ProductServiceTests {<br>
    private readonly Mock&lt;IProductRepository&gt; _mockRepo;<br>
    <br>
    [Fact]<br>
    public async Task GetProduct_ReturnsProduct_WhenExists() {<br>
        // Arrange<br>
        _mockRepo.Setup(r => r.GetByIdAsync(1))<br>
            .ReturnsAsync(new Product { Id = 1, Name = "Test" });<br>
        <br>
        // Act<br>
        var result = await _service.GetProductAsync(1);<br>
        <br>
        // Assert<br>
        Assert.NotNull(result);<br>
    }<br>
}
                    </div>
                </div>
                
                <div class="highlight" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border: none; margin: 20px 0;">
                    <div class="highlight-title" style="color: #004085; font-size: 1.3em;">🚀 Deployment & DevOps</div>
                    <div style="line-height: 1.8; color: #333;">
                        • استخدم <strong>Docker</strong> للـ containerization<br>
                        • طبق <strong>CI/CD Pipeline</strong> (Azure DevOps, GitHub Actions)<br>
                        • استخدم <strong>Blue-Green Deployment</strong> أو <strong>Canary Releases</strong><br>
                        • فعّل <strong>Auto-scaling</strong> في الـ cloud<br>
                        • طبق <strong>Infrastructure as Code</strong> (Terraform, ARM)<br>
                        • راقب <strong>Application Metrics</strong> في الإنتاج
                    </div>
                </div>
            </div>
            
            <div class="flow-diagram" style="margin-top: 50px;">
                <div class="flow-box">🌐 Browser</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">🌍 Internet</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">🖥️ Server</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">🎮 Controller</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">💼 Service</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">🗄️ Database</div>
            </div>
        </div>
    </div>
</body>
</html>